version: '1.0'
steps:
  BuildDockerImage:
    title: Building Docker Image
    type: build

  SeeEnv:
    title: See env vars
    image: ${{BuildDockerImage}}
    commands:
      - env
      - ls
      - pwd

  InitTerraform:
    title: Initialize Terraform
    image: ${{BuildDockerImage}}
    commands:
      - echo "terraform init"
    when:
      condition:
        all:
          isPR: Boolean(${{CF_PULL_REQUEST_ACTION}})
          isPRTargetMaster: ${{CF_PULL_REQUEST_TARGET}} == "master"    

  DeployReviewEnv:
    title: Deploy review environment
    image: ${{BuildDockerImage}}
    commands:
      - echo "terraform apply -auto-approve"
    when:
      condition:
        all:
          isPR: Boolean(${{CF_PULL_REQUEST_ACTION}})
          isPRTargetMaster: ${{CF_PULL_REQUEST_TARGET}} == "master"
          isPROpenOrSync: ${{CF_PULL_REQUEST_ACTION}} == "opened" || ${{CF_PULL_REQUEST_ACTION}} == "synchronize" || ${{CF_PULL_REQUEST_ACTION}} == "reopened"
  
  RemoveReviewEnv:
    title: Remove review environment
    image: ${{BuildDockerImage}}
    commands:
      - echo "terraform destroy"
    when:
      condition:
        all:
          isPR: Boolean(${{CF_PULL_REQUEST_ACTION}})
          isPRTargetMaster: ${{CF_PULL_REQUEST_TARGET}} == "master"
          isPRClosed: ${{CF_PULL_REQUEST_ACTION}} == "closed"


  PushDockerImage:
    title: Push Docker image
    type: push
    candidate: ${{BuildDockerImage}}
    image_name: jeffmaher/codefresh-events-poc
    tag: ${{CF_RELEASE_TAG}}
    registry: ecr-temp_cammis
    when:
      condition:
        all:
          isReleaseEvent: ${{CF_RELEASE_TAG}} != Null
          hasSemVer: match( ${{CF_RELEASE_TAG}}, "^\d+\.\d+\.\d+$", false )

