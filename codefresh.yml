version: '1.0'
steps:
  BuildDockerImage:
    title: Building Docker Image
    type: build
    image_name: jeffmaher/codefresh-events-poc

  SeeEnv:
    title: See env vars
    image: ${{BuildDockerImage}}
    commands:
      - env
      - ls
      - pwd

  InitTerraform:
    title: Initialize Terraform
    image: ${{BuildDockerImage}}
    commands:
      - echo "[JM_OUT] terraform init"
    when:
      condition:
        all:
          isPR: 'Boolean("${{CF_PULL_REQUEST_ACTION}}")'
          isPRTargetMaster: '"${{CF_PULL_REQUEST_TARGET}}" == "master"'    

  DeployReviewEnv:
    title: Deploy review environment
    image: ${{BuildDockerImage}}
    commands:
      - echo "[JM_OUT] terraform apply -auto-approve"
    when:
      condition:
        all:
          isPR: 'Boolean("${{CF_PULL_REQUEST_ACTION}}")'
          isPRTargetMaster: '"${{CF_PULL_REQUEST_TARGET}}" == "master"' 
          isPROpenOrSync: '"${{CF_PULL_REQUEST_ACTION}}" == "opened" || "${{CF_PULL_REQUEST_ACTION}}" == "synchronize" || "${{CF_PULL_REQUEST_ACTION}}" == "reopened"'
  
  RemoveReviewEnv:
    title: Remove review environment
    image: ${{BuildDockerImage}}
    commands:
      - echo "[JM_OUT] terraform destroy"
    when:
      condition:
        all:
          isPR: 'Boolean("${{CF_PULL_REQUEST_ACTION}}")'
          isPRTargetMaster: '"${{CF_PULL_REQUEST_TARGET}}" == "master"' 
          isPROpenOrSync: '"${{CF_PULL_REQUEST_ACTION}}" == "closed"'

  PushDockerImage:
    title: Push Docker image
    type: push
    candidate: ${{BuildDockerImage}}
    image_name: jeffmaher/codefresh-events-poc
    tag: ${{CF_RELEASE_TAG}}
    registry: ecr-temp_cammis
    when:
      condition:
        all:
          isNotPR: '${{CF_PULL_REQUEST_ACTION}} == null'
          releaseTagHasSemVerFormat: 'match( "${{CF_BRANCH_TAG_NORMALIZED}}", "^\d+\.\d+\.\d+$", false )'